<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>TILT ‚Äì Dev UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow px-6 py-4 flex justify-between items-center">
      <h1 class="text-xl font-semibold">TILT ‚Äì Dev UI</h1>

      <div class="flex items-center gap-2">
        <span id="usernameLabel" class="text-sm text-gray-600"></span>
        <button
          onclick="resetUser()"
          class="text-xs text-red-500 underline"
        >
          change
        </button>
      </div>
    </div>

    <!-- Main -->
    <div class="max-w-xl mx-auto mt-8 bg-white p-6 rounded shadow">
      <!-- Create topic -->
      <div class="flex gap-2 mb-4">
        <input
          id="topicInput"
          placeholder="Enter topic"
          class="flex-1 border px-3 py-2 rounded"
        />
        <button
          onclick="createTopic()"
          class="bg-blue-600 text-white px-4 rounded"
        >
          Create
        </button>
      </div>

      <button onclick="loadTopics()" class="text-sm text-blue-600 mb-4">
        Load topics
      </button>

      <ul id="topics" class="space-y-3"></ul>
    </div>

    <script>
      const API = "http://localhost:3000";

      // ---------- identity ----------
      function ensureUser() {
        let userId = localStorage.getItem("userId");
        let username = localStorage.getItem("username");

        if (!userId || !username) {
          username = prompt("Enter your username");
          if (!username) throw new Error("Username required");

          userId = crypto.randomUUID();
          localStorage.setItem("userId", userId);
          localStorage.setItem("username", username);
        }

        document.getElementById("usernameLabel").textContent = username;
        return { userId, username };
      }

      function resetUser() {
        localStorage.removeItem("userId");
        localStorage.removeItem("username");
        location.reload();
      }

      ensureUser();

      // ---------- API calls ----------
      async function createTopic() {
        const topic = document.getElementById("topicInput").value.trim();
        if (!topic) return;

        const { userId, username } = ensureUser();

        await fetch(`${API}/topics`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-user-id": userId,
            "x-username": username
          },
          body: JSON.stringify({ topic })
        });

        document.getElementById("topicInput").value = "";
        loadTopics();
      }

      async function loadTopics() {
        const res = await fetch(`${API}/topics`);
        const data = await res.json();

        const list = document.getElementById("topics");
        list.innerHTML = "";

        data.forEach(t => {
          const li = document.createElement("li");
          li.className = "border rounded p-3 flex justify-between items-center";

          li.innerHTML = `
            <div>
              <p class="font-medium">${t.topic}</p>
              <p class="text-xs text-gray-500">by ${t.createdByName}</p>
              <p class="text-sm mt-1">
                üëç ${t.upCount} &nbsp; üëé ${t.downCount}
              </p>
            </div>

            <div class="flex gap-2">
              <button onclick="vote('${t.id}', 'up')" class="text-sm px-2 py-1 bg-green-100 rounded">Up</button>
              <button onclick="vote('${t.id}', 'down')" class="text-sm px-2 py-1 bg-red-100 rounded">Down</button>
              <button onclick="del('${t.id}')" class="text-sm px-2 py-1 bg-gray-200 rounded">Delete</button>
            </div>
          `;
          list.appendChild(li);
        });
      }

      async function vote(id, value) {
        const { userId, username } = ensureUser();

        await fetch(`${API}/topics/${id}/vote`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-user-id": userId,
            "x-username": username
          },
          body: JSON.stringify({ value })
        });

        loadTopics();
      }

      async function del(id) {
        const { userId, username } = ensureUser();

        await fetch(`${API}/topics/${id}`, {
          method: "DELETE",
          headers: {
            "x-user-id": userId,
            "x-username": username
          }
        });

        loadTopics();
      }
    </script>
  </body>
</html>
